# 1. ウィンドウ関数
```sql
psql -U postgres -d shop

-- shohin_bunrui毎に、hanbai_tankaで順序をつける
-- PARTITION BY で 分けられたグループをウィンドウと呼ぶ
SELECT shohin_mei, shohin_bunrui, hanbai_tanka,
  RANK () OVER (PARTITION BY shohin_bunrui
                    ORDER BY hanbai_tanka) AS ranking
  FROM Shohin;

-- PARTITION_BY が無ければただ順位がつく
SELECT shohin_mei, shohin_bunrui, hanbai_tanka,
  RANK () OVER (ORDER BY hanbai_tanka) AS ranking
  FROM Shohin;

-- RANK以外にもDENSE_RANK, ROW_NUMBERがある
-- これらは順位が重なったときの処理が違う
-- DENSE_RANK: 1位が2人いても、次は2位から始まる
-- ROW_NUMBER: 順位が同じ場合は、適当な順位をつける
SELECT shohin_mei, shohin_bunrui, hanbai_tanka,
  RANK () OVER (ORDER BY hanbai_tanka) AS ranking,
  DENSE_RANK () OVER (ORDER BY hanbai_tanka) AS dense_ranking,
  ROW_NUMBER () OVER (ORDER BY hanbai_tanka) AS row_num
  FROM Shohin;

-- Window関数ではなく、普通の集約関数を使う場合は()の書き方が変わる
-- 累計を計算可能
SELECT shohin_id, shohin_mei, hanbai_tanka,
   SUM (hanbai_tanka) OVER (ORDER BY shohin_id) AS current_sum
  FROM Shohin;

-- 移動平均を計算
-- ROWS 2 PRECEDING で 2行前までの意味
-- FOLLOWING で2行後までも指定可能
SELECT shohin_id, shohin_mei, hanbai_tanka,
       AVG (hanbai_tanka) OVER (ORDER BY shohin_id ROWS 2 PRECEDING) AS moving_avg
  FROM Shohin;

-- 前後を組み合わせることも可能
SELECT shohin_id, shohin_mei, hanbai_tanka,
       AVG (hanbai_tanka) OVER (ORDER BY shohin_id ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) AS moving_avg
  FROM Shohin;

-- Window関数のOrder Byは計算の時に使われるだけなので、表示の順序を変えたければもう一度Order Byが必要
SELECT shohin_mei, shohin_bunrui, hanbai_tanka,
       RANK () OVER (ORDER BY hanbai_tanka) AS ranking
  FROM Shohin
 ORDER BY ranking;
```