# 1. 仮想サーバーを構築する

* EC2で作成した仮想サーバーをインスタンスという
* 作成したインスタンスはVPC内で通信するためのプライベートIPアドレスとインターネットで通信するためのパブリックIPアドレスを持つ
    * パブリックIPアドレスはAWSに割り当てられているIPアドレスブロックの内、適当なものが使われる

### インスタンスを作成する
* EC2 ⇒ インスタンスを起動 ⇒ Amazon Linux2 AMIを選択 ⇒ t2.microを選択 ⇒ 次のステップ
* ネットワークとして「VPC領域」を選択 ⇒ サブネットとして「パブリックサブネットを選択」
    * 自動割り当てパブリックIP を有効に設定(インターネットからアクセスできるようにする)
    * ネットワークインターフェースのプライマリIPに10.0.1.10 と入力（インスタンスにプライベートIPアドレスを設定) ⇒ 次のステップ
* EBSは8GBのまま次のステップ
* タグを設定 Name : Webサーバー
* セキュリティグループ名をWEB-SGに変更 ⇒ 確認と作成
* 内容を確認し起動
* 新しいキーペアの作成 ⇒ キーペア名をmy-key に設定

# 2. SSHで接続する

以下で接続可能。
* TeraTermを起動 ⇒ ホストにIPv4アドレスを入力 ⇒ OK
* 続行をクリック
* ユーザー名にec2-userと入力
    * RSA/DSA/ECDSA/ED25519鍵を使うを選択 ⇒ 秘密鍵を選択
* OKをクリック

コマンドプロンプトを使って以下でも接続可能。
* VPC で DNSホスト名を編集 ⇒ DNSホスト名を有効化

```sh
# Amazon Linux2の場合、ec2-user というデフォルトのユーザーが設定されている
ssh -i my-key.pem ec2-user@<Public DNS名>
```

### パブリックIPアドレスを固定するには
* Elastic IP をクリック ⇒ Elastic IPアドレスの割り当てをクリック
* アクション ⇒ Elastic IPアドレスの関連付け をクリック ⇒ EC2インスタンスを選択し、関連付けるをクリック

# 3. IPアドレスとポート番号
ルーティングの為には、ルートテーブル同士が情報を交換しなければならない。  
これはルーティングプロトコルと呼ばれる仕組みで実現されており以下の2つからなる
* EGP(Exterior Gateway Protocol)
    * ISP(Internet Service Provider)やAWS等のある程度大きなネットワークは、AS(Autonomous System)番号を持っている
    * このAS番号をやり取りして、どのネットワークの先に、どのネットワークが接続されているのかを大まかにやり取りする
    * 日本や東京都　等のおおまかな住所をやり取りするイメージ
* IGP(Interior Gateway Protocol)
    * ある程度大きなネットワーク内のルーター同士で、ルートテーブルの情報をやり取りする
    * 細かい住所をIGPで情報交換するイメージ

### サーバー側のサービスとポートの関係
* TCP/IPで通信するサーバーなどの機器には、他のコンピュータとデータを送受信するための出入り口（ポート）が用意されている
* ポートは0-65535まである
* ポートには2種類ある
    * 相手にデータが届いたことを保証するTCP(Transmission Control Protocol)
    * 確認せずに高速に送信するUDP(User Datagram Protocol)

```sh
# sshログインした状態で、実行
# どのポート番号でどのプログラムが待ち受けているかを確認
# sshd がssh接続を受け入れるプログラムで22番になっている
sudo lsof -i -n -P
```

* TCP *:22 となっているのは どのIPでも接続可能の意味
* ESTABLISHED となっているのは通信中のポート、LISTENが他のコンピュータからの待ち受けをしているポート
* TCP 127.0.0.1:25 となっているものは、他のコンピュータからの接続は受け付けないという意味
    * 127.0.0.1 はループバックアドレスと呼ばれて自分自身を表す特別なIPアドレス
* 代表的なアプリケーションが使うポート番号はウェルノウンポート番号と呼ばれて、SSHが22、HTTPが80番など決まっている
* TeraTerm ⇒ EC2はポート番号22で接続している
    * EC2 ⇒ TeraTermはランダムなポート番号(ex:57384) で返信されている
    * Established の 10.0.1.10:22 -> <自分のIP>:58384 がそれを表している

# 4. ファイアウォールで接続制限する
* セキュリティを高めるにはファイアウォールを設ける
    * ファイアウォール：通してよいデータだけを通す機能
        * 最も簡単な構造が、パケットフィルタリング
* パケットフィルタリング: IPアドレスとポート番号などのパケットに付随する情報を見て通過の可否を決める
* AWSではインスタンスに対して構成する「セキュリティグループ」がこの機能を担当する
    * 現在はポート22番を用いるSSH接続だけ可能な状態になっている


