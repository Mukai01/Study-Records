# 1. プライベートサブネットを作る
* パブリックサブネットを10.0.1.0/24 として作成した
    * プライベートサブネットは10.0.2.0/24 とする
* まずパブリックサブネットを確認し、どのアベイラビリティーゾーンかを確認する
    * 別のアベイラビリティゾーンでもよいが、遅延や通信料の関係から今回は同じにする
* VPC ⇒ サブネット ⇒ サブネットの作成
    * サブネット名: プライベートサブネット, アベイラビリティゾーン: 上記
    * CIDRブロック: 10.0.2.0/24
* ルートテーブルは自身のネットワークに対するルーティングの設定だけされている状態
    * 今回はインターネットに接続しない為このままでOK
    
# 2. プライベートサブネットにサーバーを構築する
* EC2 ⇒ インスタンスの作成 ⇒ AmazonLinux2 AMI
* ネットワーク: VPC領域, サブネット: プライベートサブネット
    * インターネットから接続させないので、自動割り当てパブリックIPを無効化
    * ネットワークインターフェイスのプライマリIPに 10.0.2.10 として、プライベートIPを設定する
* タグに Name: DBサーバーを追加
* セキュリティグループ名に DB-SGを名前を付ける
    * 今後MariaDBの通信も許したいので、タイプ: MYSQL/Aurora、ポート:3306、ソース：任意の場所として作成する

* 次にPingコマンドで疎通確認をする
    * pingコマンドではICMP(Internet Control Message Protocol) というプロトコルを使う
    * エコー要求というパケットを送信すると、ホストがICMPエコー応答というパケットを返信する
* ICMPを許可するために、セキュリティグループでDB-SGを選択
    * インバウンドルールに タイプ: 全てのICMP、ソース: 任意の場所として保存
    * 同じことをWEB-SGに対しても実行

```sh
# Webサーバーにsshログインした後、以下コマンドで疎通を確認可能
ping 10.0.2.10

# またWebサーバーはローカルから疎通を確認可能
ping <public DNS名>

# データベースサーバーはローカルからは確認不可
# これはインターネットゲートウェイへのルーティングを設定していないのと、パブリックDNS名が無い為
```

# 3. 踏み台サーバーを経由してSSHで接続する
* DBサーバーにMariaDBをインストールしたいが、インターネットと接続されていない
    * そのため、Webサーバーを踏み台サーバーとして利用する
* Webサーバーに秘密鍵を送るために、SCP(Secure Copy)というプロトコルを使う
    * TeraTermでWebサーバーにログイン ⇒ ファイル ⇒ SSH SCP
    * From : .pemファイルを指定、TO : ~/ としてSendボタンをクリック

```sh
# webサーバーにSSHログイン後
# pemファイルを自分だけが読み取れるように変更
chmod 400 my-key.pem

# Webサーバーを踏み台にし、DBサーバーにSSH接続
ssh -i my-key.pem ec2-user@10.0.2.10
```
